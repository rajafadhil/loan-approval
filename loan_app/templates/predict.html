<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Prediction - Bank Kuy</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="predict-page">
    <nav>
        <ul>
            <li><a href="{{ url_for('home') }}">Home</a></li>
            <li><a href="{{ url_for('home') }}#about">About Us</a></li>
            <li><a href="{{ url_for('home') }}#services">Services</a></li>
            <li><a href="{{ url_for('home') }}#contact">Contact</a></li>
            <li><a href="/predict">Loan Predict</a></li>
        </ul>
    </nav>
    <div class="container">
        <h1 style="color: rgb(18, 18, 18);">üìä Loan Approval Prediction</h1>
        <p>Isi form berikut untuk menghasilkan prediksi persetujuan pinjaman.</p>

        <form method="POST">
            <div class="form-section">
                <h3>Personal Information</h3>
                <div class="form-group">
                    <label for="occupation_status">Occupation Status:</label>
                    <span class="help-icon" onclick="toggleTooltip(this)">?</span>
                    <div class="tooltip">Pilih status pekerjaan Anda saat ini. Employed: Bekerja tetap, Student: Mahasiswa, Self-Employed: Wiraswasta.</div>
                    <select id="occupation_status" name="occupation_status" required>
                        <option value="Employed">Employed</option>
                        <option value="Student">Student</option>
                        <option value="Self-Employed">Self-Employed</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="years_employed">Years Employed:</label>
                    <span class="help-icon" onclick="toggleTooltip(this)">?</span>
                    <div class="tooltip">Jumlah tahun pengalaman bekerja. Rentang: 0 - 50 tahun.</div>
                    <input type="number" step="0.1" id="years_employed" name="years_employed" required>
                </div>


            </div>

            <div class="form-section">
                <h3>Credit History</h3>
                <div class="form-group">
                    <label for="credit_score">Credit Score:</label>
                    <span class="help-icon" onclick="toggleTooltip(this)">?</span>
                    <div class="tooltip">Skor kredit Anda dari lembaga kredit. Rentang: 300 - 850.</div>
                    <input type="number" id="credit_score" name="credit_score" required>
                </div>

                <div class="form-group">
                    <label for="credit_history_years">Credit History Years:</label>
                    <span class="help-icon" onclick="toggleTooltip(this)">?</span>
                    <div class="tooltip">Lama Anda memiliki riwayat kredit. Rentang: 0 - 50 tahun.</div>
                    <input type="number" step="0.1" id="credit_history_years" name="credit_history_years" required>
                </div>

                <div class="form-group">
                    <label for="defaults_on_file">Defaults on File:</label>
                    <span class="help-icon" onclick="toggleTooltip(this)">?</span>
                    <div class="tooltip">Apakah Anda pernah gagal bayar pinjaman sebelumnya? No: Tidak pernah, Yes: Pernah.</div>
                    <select id="defaults_on_file" name="defaults_on_file" required>
                        <option value="0">No</option>
                        <option value="1">Yes</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="delinquencies_last_2yrs">Delinquencies Last 2 Years:</label>
                    <span class="help-icon" onclick="toggleTooltip(this)">?</span>
                    <div class="tooltip">Jumlah keterlambatan pembayaran dalam 2 tahun terakhir. Rentang: 0 - 20.</div>
                    <input type="number" id="delinquencies_last_2yrs" name="delinquencies_last_2yrs" required>
                </div>

                <div class="form-group">
                    <label for="derogatory_marks">Derogatory Marks:</label>
                    <span class="help-icon" onclick="toggleTooltip(this)">?</span>
                    <div class="tooltip">Jumlah catatan negatif dalam riwayat kredit. Rentang: 0 - 20.</div>
                    <input type="number" id="derogatory_marks" name="derogatory_marks" required>
                </div>
            </div>

            <div class="form-section">
                <h3>Loan Details</h3>
                <div class="form-group">
                    <label for="product_type">Product Type:</label>
                    <span class="help-icon" onclick="toggleTooltip(this)">?</span>
                    <div class="tooltip">Jenis produk pinjaman yang diminta. Credit Card: Kartu kredit, Line of Credit: Garis kredit, Personal Loan: Pinjaman pribadi.</div>
                    <select id="product_type" name="product_type" required>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Line of Credit">Line of Credit</option>
                        <option value="Personal Loan">Personal Loan</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="loan_intent">Loan Intent:</label>
                    <span class="help-icon" onclick="toggleTooltip(this)">?</span>
                    <div class="tooltip">Tujuan penggunaan pinjaman. Business: Bisnis, Home Improvement: Perbaikan rumah, Debt Consolidation: Konsolidasi utang, Education: Pendidikan, Medical: Kesehatan, Personal: Pribadi.</div>
                    <select id="loan_intent" name="loan_intent" required>
                        <option value="Business">Business</option>
                        <option value="Home Improvement">Home Improvement</option>
                        <option value="Debt Consolidation">Debt Consolidation</option>
                        <option value="Education">Education</option>
                        <option value="Medical">Medical</option>
                        <option value="Personal">Personal</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="loan_amount">Loan Amount:</label>
                    <span class="help-icon" onclick="toggleTooltip(this)">?</span>
                    <div class="tooltip">Jumlah pinjaman yang diminta dalam USD. Rentang: 1000 - 100000.</div>
                    <input type="number" id="loan_amount" name="loan_amount" required>
                </div>

                <div class="form-group">
                    <label for="interest_rate">Interest Rate (%):</label>
                    <span class="help-icon" onclick="toggleTooltip(this)">?</span>
                    <div class="tooltip">Suku bunga pinjaman dalam persen. Rentang: 0.01 - 30.00.</div>
                    <input type="number" step="0.01" id="interest_rate" name="interest_rate" required>
                </div>

                <div class="form-group">
                    <label for="debt_to_income_ratio">Debt to Income Ratio:</label>
                    <span class="help-icon" onclick="toggleTooltip(this)">?</span>
                    <div class="tooltip">Rasio utang terhadap pendapatan. Rentang: 0.001 - 1.000.</div>
                    <input type="number" step="0.001" id="debt_to_income_ratio" name="debt_to_income_ratio" required>
                </div>

                <div class="form-group">
                    <label for="loan_to_income_ratio">Loan to Income Ratio:</label>
                    <span class="help-icon" onclick="toggleTooltip(this)">?</span>
                    <div class="tooltip">Rasio pinjaman terhadap pendapatan. Rentang: 0.001 - 1.000.</div>
                    <input type="number" step="0.001" id="loan_to_income_ratio" name="loan_to_income_ratio" required>
                </div>

                <div class="form-group">
                    <label for="payment_to_income_ratio">Payment to Income Ratio:</label>
                    <span class="help-icon" onclick="toggleTooltip(this)">?</span>
                    <div class="tooltip">Rasio pembayaran cicilan terhadap pendapatan. Rentang: 0.001 - 1.000.</div>
                    <input type="number" step="0.001" id="payment_to_income_ratio" name="payment_to_income_ratio" required>
                </div>
            </div>

            <button type="submit">Predict</button>
        </form>

        {% if prediction %}
        <div class="result">
            <h2>Hasil Prediksi:</h2>
            <p>{{ prediction }} (Confidence: {{ confidence }})</p>
        </div>
        {% endif %}
    </div>
    <!-- Floating Chatbot Widget -->
    <div id="chatbot-widget">
        <div id="chatbot-icon" onclick="toggleChat()">üí¨</div>
        <div id="chatbot-window">
            <div id="chatbot-header">
                <span>Asisten Keuangan UMKM</span>
                <div class="header-buttons">
                    <button onclick="clearChatHistory()" title="Clear Chat History">üóëÔ∏è</button>
                    <button onclick="toggleChat()">√ó</button>
                </div>
            </div>
            <div id="chatbot-messages"></div>
            <form id="chatbot-form">
                <div id="chatbot-input-container">
                    <input type="text" id="chatbot-input" placeholder="Ketik pertanyaan Anda..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                    <button id="chatbot-send-btn">Kirim</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function toggleChat() {
            const window = document.getElementById('chatbot-window');
            window.style.display = window.style.display === 'block' ? 'none' : 'block';
        }

        function clearChatHistory() {
            const messagesDiv = document.getElementById('chatbot-messages');
            messagesDiv.innerHTML = '';
        }

        document.getElementById('chatbot-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const message = document.getElementById('chatbot-input').value;
            if (message.trim() === '') return;

            // Add user message
            addMessage(message, 'user');

            // Clear input
            document.getElementById('chatbot-input').value = '';

            // Show responding message
            addMessage('Sedang merespons...', 'bot responding');

            // Disable input while processing
            document.getElementById('chatbot-input').disabled = true;
            document.querySelector('#chatbot-form button').disabled = true;

            // Send to server
            fetch('/chatbot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'message=' + encodeURIComponent(message)
            })
            .then(response => response.json())
            .then(data => {
                // Remove responding message
                removeRespondingMessage();
                // Add bot response
                addMessage(data.response, 'bot');
            })
            .catch(error => {
                // Remove responding message
                removeRespondingMessage();
                addMessage('Terjadi error: ' + error.message, 'bot');
            })
            .finally(() => {
                // Re-enable input
                document.getElementById('chatbot-input').disabled = false;
                document.querySelector('#chatbot-form button').disabled = false;
            });
        });

        function parseMarkdown(text) {
            // Convert markdown to HTML
            let html = text;
            
            // Bold: **text** or __text__
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
            
            // Italic: *text* or _text_
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            html = html.replace(/_(.+?)_/g, '<em>$1</em>');
            
            // Line breaks
            html = html.replace(/\n/g, '<br>');
            
            // Lists (simple implementation)
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/^‚Ä¢ (.+)$/gm, '<li>$1</li>');
            
            // Wrap consecutive <li> tags in <ul>
            html = html.replace(/(<li>.*<\/li>\s*)+/g, '<ul>$&</ul>');
            
            return html;
        }

        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('chatbot-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chatbot-message ' + sender;
            
            // For bot messages, parse markdown; for user messages, use plain text
            if (sender.includes('bot')) {
                messageDiv.innerHTML = parseMarkdown(text);
            } else {
                messageDiv.textContent = text;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeRespondingMessage() {
            const messagesDiv = document.getElementById('chatbot-messages');
            const respondingMessages = messagesDiv.querySelectorAll('.responding');
            respondingMessages.forEach(msg => msg.remove());
        }
    </script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>
